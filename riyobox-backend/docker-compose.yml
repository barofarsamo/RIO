version: '3.8'

services:
  # MongoDB
  mongodb:
    image: mongo:latest
    container_name: riyobox-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongodb/init.js:/docker-entrypoint-initdb.d/init.js:ro
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin123
      - MONGO_INITDB_DATABASE=riyobox
    command: mongod --bind_ip_all --replSet rs0
    restart: unless-stopped
    networks:
      - riyobox-network

  # Redis
  redis:
    image: redis:alpine
    container_name: riyobox-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --requirepass redis123
    restart: unless-stopped
    networks:
      - riyobox-network

  # Backend API
  backend:
    build: .
    container_name: riyobox-backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - MONGODB_URI=mongodb://riyobox_admin:admin123@mongodb:27017/riyobox?authSource=admin&replicaSet=rs0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis123
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-2024}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-riyobox-storage}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - TZ=UTC
    depends_on:
      - mongodb
      - redis
    restart: unless-stopped
    networks:
      - riyobox-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Admin Panel (Nginx)
  admin:
    image: nginx:alpine
    container_name: riyobox-admin
    ports:
      - "3000:80"
    volumes:
      - ./admin-panel/dist:/usr/share/nginx/html
      - ./nginx/admin.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - riyobox-network

  # MongoDB Initialization (runs once)
  mongo-init:
    image: mongo:latest
    container_name: riyobox-mongo-init
    depends_on:
      - mongodb
    restart: "no"
    entrypoint: >
      bash -c "
        echo 'Waiting for MongoDB to start...' &&
        sleep 20 &&
        echo 'Initializing replica set...' &&
        mongosh --host mongodb:27017 -u admin -p admin123 --authenticationDatabase admin --eval '
          rs.initiate({
            _id: \"rs0\",
            members: [{ _id: 0, host: \"mongodb:27017\" }]
          })' &&
        echo 'Creating application user...' &&
        mongosh --host mongodb:27017 -u admin -p admin123 --authenticationDatabase admin --eval '
          db = db.getSiblingDB(\"riyobox\");
          db.createUser({
            user: \"riyobox_admin\",
            pwd: \"admin123\",
            roles: [{ role: \"readWrite\", db: \"riyobox\" }]
          })' &&
        echo 'âœ… Database initialized successfully!'
      "
    networks:
      - riyobox-network

networks:
  riyobox-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
