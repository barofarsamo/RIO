name: Android CI/CD (Debuggable)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        working-directory: riyobox-android

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > keystore.jks
        working-directory: riyobox-android

      # üî¥ TALLAABADA MUHIIMKA AH
      # Halkan ayaan si qasab ah APK u dhisaynaa
      - name: Build APK ONLY (force)
        run: ./gradlew :app:assembleRelease
        working-directory: riyobox-android

      # üîç HUBINTA DHABTA AH
      - name: SHOW ALL APK FILES
        run: |
          echo "====== APK FILES FOUND ======"
          find riyobox-android -type f -name "*.apk" || true
          echo "============================="

      # ‚ùå Haddii wax APK ah jirin ‚Üí halkan ayuu ku caddaanayaa
      - name: Fail if no APK exists
        run: |
          APK_COUNT=$(find riyobox-android -type f -name "*.apk" | wc -l)
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "‚ùå NO APK WAS GENERATED. FIREBASE CANNOT WORK."
            exit 1
          fi

      # ‚úÖ HADDII APK JIRO ‚Üí FIREBASE AYAA LA DIRAYAA
      - name: Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          groups: testers
          file: riyobox-android/**/*.apk
